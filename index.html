<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Courier Logbook Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h2 {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .login-header p {
            color: var(--secondary);
            margin: 0;
        }
        
        .form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(0,86,179,0.25);
        }
        
        .btn-login {
            background: var(--primary);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-login:hover {
            background: #004494;
            transform: translateY(-2px);
        }
        
        .main-container {
            background: var(--light);
            min-height: 100vh;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .nav-link {
            font-weight: 500;
            margin: 0 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .card-header {
            background: var(--primary);
            color: white;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .badge {
            border-radius: 6px;
            font-weight: 500;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background: var(--light);
            border: none;
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tbody tr:hover {
            background: rgba(0,86,179,0.05);
        }
        
        .entry-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .committed-entry {
            background: rgba(40,167,69,0.1);
        }
        
        .edit-request-badge {
            background: var(--warning);
            color: var(--dark);
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .activity-item {
            border-left: 4px solid var(--primary);
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .remarks-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .remark-item {
            background: white;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }
        
        .remark-author {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.85rem;
        }
        
        .remark-time {
            color: var(--secondary);
            font-size: 0.75rem;
        }
        
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--primary), #004494);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-clipboard-list fa-3x text-primary mb-3"></i>
                <h2>VM Courier Logbook</h2>
                <p>Village Mall Portal</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginId" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="loginId" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">Remember Me</label>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-login">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </button>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <span class="navbar-brand">
                    <i class="fas fa-clipboard-list me-2"></i>VM Courier Logbook
                </span>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="#" onclick="showPage('logbook')">
                        <i class="fas fa-book me-1"></i>Logbook
                    </a>
                    <a class="nav-link" href="#" onclick="showPage('users')">
                        <i class="fas fa-users me-1"></i>Users
                    </a>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
                            <div class="user-avatar d-inline-flex me-2" id="userAvatar"></div>
                            <span id="currentUserName"></span>
                            <span id="editRequestBadge" class="notification-badge" style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Logbook Page -->
        <div id="logbookPage" class="page-section active">
            <div class="container mt-4">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="stats-number" id="totalEntries">0</div>
                                    <div>Total Entries</div>
                                </div>
                                <i class="fas fa-clipboard-list fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="stats-number" id="committedEntries">0</div>
                                    <div>Committed</div>
                                </div>
                                <i class="fas fa-lock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="stats-number" id="myEntries">0</div>
                                    <div>My Entries</div>
                                </div>
                                <i class="fas fa-user fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="stats-number" id="pendingRequests">0</div>
                                    <div>Edit Requests</div>
                                </div>
                                <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Entry Button -->
                <div class="row mb-3">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#entryModal" onclick="openAddEntryModal()">
                            <i class="fas fa-plus me-2"></i>Add New Entry
                        </button>
                        <button id="viewDeletedBtn" class="btn btn-outline-secondary ms-2" onclick="toggleDeletedEntries()" style="display: none;">
                            <i class="fas fa-trash me-2"></i>View Deleted Entries
                        </button>
                    </div>
                </div>

                <!-- Logbook Entries -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Logbook Entries
                            <span id="entriesTitle">All Entries</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>PIC</th>
                                        <th>Destination</th>
                                        <th>Photo</th>
                                        <th>Remarks</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Page -->
        <div id="usersPage" class="page-section">
            <div class="container mt-4">
                <div class="row">
                    <!-- User Profile/List -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i><span id="usersTitle">User Management</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Log (Admin Only) -->
                    <div class="col-md-4" id="activityLogSection" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-history me-2"></i>Recent Activity
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="activityLog" style="max-height: 400px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalTitle">Add New Entry</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="entryDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="entryPIC" class="form-label">PIC (Person in Charge)</label>
                                    <input type="text" class="form-control" id="entryPIC" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="entryDestination" class="form-label">Destination</label>
                            <select class="form-select" id="entryDestination" required>
                                <option value="">Select Destination</option>
                                <option value="ENB">ENB</option>
                                <option value="Remobie">Remobie</option>
                                <option value="Miifix">Miifix</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="entryPhoto" class="form-label">Courier Photo Proof</label>
                            <input type="file" class="form-control" id="entryPhoto" accept="image/*">
                            <div id="photoPreview"></div>
                        </div>
                        <div class="mb-3">
                            <label for="entryRemarks" class="form-label">Initial Remarks (Optional)</label>
                            <textarea class="form-control" id="entryRemarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remarks Modal -->
    <div class="modal fade" id="remarksModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Entry Remarks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="remarks-list" id="remarksList"></div>
                    <div class="mt-3">
                        <label for="newRemark" class="form-label">Add New Remark</label>
                        <textarea class="form-control" id="newRemark" rows="3" placeholder="Enter your remark..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addRemark()">Add Remark</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Edit Permission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This entry is committed and locked. Please provide a reason for requesting edit permission:</p>
                    <textarea class="form-control" id="editRequestReason" rows="4" placeholder="Reason for edit request..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitEditRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Courier Photo Proof</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPhoto" class="img-fluid" style="max-height: 70vh;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Application State
        let currentUser = null;
        let currentEntryId = null;
        let currentRemarksEntryId = null;
        let showingDeleted = false;
        
        // Data Storage
        let users = [
            { id: '7434', name: 'Admin User', role: 'admin', password: 'admin123', canCommit: true },
            { id: '1001', name: 'John Doe', role: 'crew', password: 'crew123', canCommit: true },
            { id: '1002', name: 'Jane Smith', role: 'crew', password: 'crew123', canCommit: false },
            { id: '1003', name: 'Mike Johnson', role: 'crew', password: 'crew123', canCommit: true }
        ];
        
        let logbookEntries = [];
        let deletedEntries = [];
        let editRequests = [];
        let activityLogs = [];
        let entryRemarks = {};

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            checkLoginStatus();
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('entryPhoto').addEventListener('change', handlePhotoPreview);
        }

        // Login Management
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('vmCourierUser');
            const rememberMe = localStorage.getItem('vmCourierRemember');
            
            if (savedUser && rememberMe === 'true') {
                const userData = JSON.parse(savedUser);
                const user = users.find(u => u.id === userData.id);
                if (user) {
                    loginUser(user);
                    return;
                }
            }
            
            showLoginPage();
        }

        function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            const user = users.find(u => u.id === id && u.password === password);
            
            if (user) {
                if (rememberMe) {
                    localStorage.setItem('vmCourierUser', JSON.stringify({id: user.id}));
                    localStorage.setItem('vmCourierRemember', 'true');
                }
                loginUser(user);
                logActivity('Login', `${user.name} logged in`);
            } else {
                showLoginError('Invalid ID or password');
            }
        }

        function loginUser(user) {
            currentUser = user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0);
            
            // Show admin features
            if (user.role === 'admin') {
                document.getElementById('viewDeletedBtn').style.display = 'inline-block';
                document.getElementById('activityLogSection').style.display = 'block';
            }
            
            updateUI();
        }

        function logout() {
            logActivity('Logout', `${currentUser.name} logged out`);
            currentUser = null;
            localStorage.removeItem('vmCourierUser');
            localStorage.removeItem('vmCourierRemember');
            showLoginPage();
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Page Navigation
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(page + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            if (page === 'users') {
                loadUsersPage();
            } else if (page === 'logbook') {
                loadLogbookPage();
            }
        }

        // Logbook Management
        function loadLogbookPage() {
            updateStats();
            renderLogbookEntries();
            updateEditRequestBadge();
        }

        function updateStats() {
            const total = logbookEntries.length;
            const committed = logbookEntries.filter(e => e.committed).length;
            const myEntries = logbookEntries.filter(e => e.createdBy === currentUser.id).length;
            const requests = editRequests.filter(r => !r.resolved).length;
            
            document.getElementById('totalEntries').textContent = total;
            document.getElementById('committedEntries').textContent = committed;
            document.getElementById('myEntries').textContent = myEntries;
            document.getElementById('pendingRequests').textContent = requests;
        }

        function renderLogbookEntries() {
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            const entriesToShow = showingDeleted ? deletedEntries : logbookEntries;
            const filteredEntries = currentUser.role === 'admin' ? entriesToShow : 
                entriesToShow.filter(e => e.createdBy === currentUser.id);
            
            document.getElementById('entriesTitle').textContent = showingDeleted ? 
                'Deleted Entries' : (currentUser.role === 'admin' ? 'All Entries' : 'My Entries');
            
            filteredEntries.forEach(entry => {
                const row = document.createElement('tr');
                if (entry.committed) {
                    row.classList.add('committed-entry');
                }
                
                const hasEditRequest = editRequests.some(r => r.entryId === entry.id && !r.resolved);
                const editRequestBadge = hasEditRequest ? 
                    '<span class="edit-request-badge ms-2">Edit Requested</span>' : '';
                
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.pic}${editRequestBadge}</td>
                    <td><span class="badge bg-primary">${entry.destination}</span></td>
                    <td>
                        ${entry.photo ? 
                            `<img src="${entry.photo}" class="entry-photo" onclick="viewPhoto('${entry.photo}')">` : 
                            '<span class="text-muted">No photo</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewRemarks(${entry.id})">
                            <i class="fas fa-comment"></i> 
                            ${entryRemarks[entry.id] ? entryRemarks[entry.id].length : 0}
                        </button>
                    </td>
                    <td>
                        ${entry.committed ? 
                            '<span class="badge bg-success"><i class="fas fa-lock"></i> Committed</span>' : 
                            '<span class="badge bg-warning text-dark">Draft</span>'
                        }
                    </td>
                    <td>${renderActionButtons(entry)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function renderActionButtons(entry) {
            if (showingDeleted) {
                return currentUser.role === 'admin' ? `
                    <button class="btn btn-sm btn-success me-1" onclick="restoreEntry(${entry.id})">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="permanentlyDeleteEntry(${entry.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
            }
            
            let buttons = '';
            
            // Edit button logic
            if (entry.committed) {
                if (currentUser.role === 'admin') {
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry(${entry.id})">
                        <i class="fas fa-edit"></i>
                    </button>`;
                } else if (entry.createdBy === currentUser.id) {
                    buttons += `<button class="btn btn-sm btn-warning me-1" onclick="requestEdit(${entry.id})">
                        <i class="fas fa-edit"></i> Request
                    </button>`;
                }
            } else {
                if (currentUser.role === 'admin' || entry.createdBy === currentUser.id) {
                    buttons += `<button class="btn btn-sm btn-primary me-1" onclick="editEntry(${entry.id})">
                        <i class="fas fa-edit"></i>
                    </button>`;
                }
            }
            
            // Delete button
            if (currentUser.role === 'admin' || (entry.createdBy === currentUser.id && !entry.committed)) {
                buttons += `<button class="btn btn-sm btn-danger me-1" onclick="deleteEntry(${entry.id})">
                    <i class="fas fa-trash"></i>
                </button>`;
            }
            
            // Commit/Uncommit button
            if (currentUser.canCommit && (currentUser.role === 'admin' || entry.createdBy === currentUser.id)) {
                if (entry.committed) {
                    if (currentUser.role === 'admin') {
                        buttons += `<button class="btn btn-sm btn-secondary" onclick="uncommitEntry(${entry.id})">
                            <i class="fas fa-unlock"></i>
                        </button>`;
                    }
                } else {
                    buttons += `<button class="btn btn-sm btn-success" onclick="commitEntry(${entry.id})">
                        <i class="fas fa-lock"></i> Commit
                    </button>`;
                }
            }
            
            return buttons;
        }

        // Entry Management
        function openAddEntryModal() {
            currentEntryId = null;
            document.getElementById('entryModalTitle').textContent = 'Add New Entry';
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('entryPIC').value = currentUser.name;
            document.getElementById('photoPreview').innerHTML = '';
        }

        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const destination = document.getElementById('entryDestination').value;
            const photoFile = document.getElementById('entryPhoto').files[0];
            const remarks = document.getElementById('entryRemarks').value;
            
            if (!date || !destination) {
                alert('Please fill in all required fields');
                return;
            }
            
            let photoData = null;
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveEntryWithPhoto(date, destination, remarks, e.target.result);
                };
                reader.readAsDataURL(photoFile);
            } else {
                saveEntryWithPhoto(date, destination, remarks, null);
            }
        }

        function saveEntryWithPhoto(date, destination, remarks, photoData) {
            if (currentEntryId) {
                // Edit existing entry
                const entry = logbookEntries.find(e => e.id === currentEntryId);
                if (entry) {
                    entry.date = date;
                    entry.destination = destination;
                    if (photoData) entry.photo = photoData;
                    entry.lastModified = new Date().toISOString();
                    
                    if (remarks) {
                        if (!entryRemarks[currentEntryId]) entryRemarks[currentEntryId] = [];
                        entryRemarks[currentEntryId].push({
                            text: remarks,
                            author: currentUser.name,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    logActivity('Edit Entry', `Entry #${currentEntryId} edited by ${currentUser.name}`);
                }
            } else {
                // Add new entry
                const newEntry = {
                    id: Date.now(),
                    date: date,
                    pic: currentUser.name,
                    destination: destination,
                    photo: photoData,
                    committed: false,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                logbookEntries.unshift(newEntry);
                
                if (remarks) {
                    entryRemarks[newEntry.id] = [{
                        text: remarks,
                        author: currentUser.name,
                        timestamp: new Date().toISOString()
                    }];
                }
                
                logActivity('Add Entry', `New entry created by ${currentUser.name}`);
            }
            
            saveToStorage();
            updateUI();
            bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
        }

        function editEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentEntryId = entryId;
            document.getElementById('entryModalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryPIC').value = entry.pic;
            document.getElementById('entryDestination').value = entry.destination;
            document.getElementById('entryRemarks').value = '';
            
            if (entry.photo) {
                document.getElementById('photoPreview').innerHTML = `
                    <img src="${entry.photo}" class="photo-preview">
                `;
            }
            
            new bootstrap.Modal(document.getElementById('entryModal')).show();
        }

        function deleteEntry(entryId) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            const entryIndex = logbookEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = logbookEntries.splice(entryIndex, 1)[0];
                deletedEntries.unshift(entry);
                logActivity('Delete Entry', `Entry #${entryId} deleted by ${currentUser.name}`);
                saveToStorage();
                updateUI();
            }
        }

        function commitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = true;
                entry.committedBy = currentUser.id;
                entry.committedAt = new Date().toISOString();
                logActivity('Commit Entry', `Entry #${entryId} committed by ${currentUser.name}`);
                saveToStorage();
                updateUI();
            }
        }

        function uncommitEntry(entryId) {
            const entry = logbookEntries.find(e => e.id === entryId);
            if (entry) {
                entry.committed = false;
                delete entry.committedBy;
                delete entry.committedAt;
                
                // Resolve any edit requests for this entry
                editRequests.forEach(req => {
                    if (req.entryId === entryId) {
                        req.resolved = true;
                        req.resolvedBy = currentUser.id;
                        req.resolvedAt = new Date().toISOString();
                    }
                });
                
                logActivity('Uncommit Entry', `Entry #${entryId} uncommitted by ${currentUser.name}`);
                saveToStorage();
                updateUI();
            }
        }

        function restoreEntry(entryId) {
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                const entry = deletedEntries.splice(entryIndex, 1)[0];
                logbookEntries.unshift(entry);
                logActivity('Restore Entry', `Entry #${entryId} restored by ${currentUser.name}`);
                saveToStorage();
                updateUI();
            }
        }

        function permanentlyDeleteEntry(entryId) {
            if (!confirm('Are you sure you want to permanently delete this entry? This cannot be undone.')) return;
            
            const entryIndex = deletedEntries.findIndex(e => e.id === entryId);
            if (entryIndex !== -1) {
                deletedEntries.splice(entryIndex, 1);
                delete entryRemarks[entryId];
                logActivity('Permanent Delete', `Entry #${entryId} permanently deleted by ${currentUser.name}`);
                saveToStorage();
                updateUI();
            }
        }

        function toggleDeletedEntries() {
            showingDeleted = !showingDeleted;
            const btn = document.getElementById('viewDeletedBtn');
            btn.innerHTML = showingDeleted ? 
                '<i class="fas fa-list me-2"></i>View Active Entries' : 
                '<i class="fas fa-trash me-2"></i>View Deleted Entries';
            renderLogbookEntries();
        }

        // Remarks Management
        function viewRemarks(entryId) {
            currentRemarksEntryId = entryId;
            const remarks = entryRemarks[entryId] || [];
            const remarksList = document.getElementById('remarksList');
            
            remarksList.innerHTML = '';
            if (remarks.length === 0) {
                remarksList.innerHTML = '<p class="text-muted">No remarks yet.</p>';
            } else {
                remarks.forEach(remark => {
                    const remarkDiv = document.createElement('div');
                    remarkDiv.className = 'remark-item';
                    remarkDiv.innerHTML = `
                        <div class="remark-author">${remark.author}</div>
                        <div>${remark.text}</div>
                        <div class="remark-time">${new Date(remark.timestamp).toLocaleString()}</div>
                    `;
                    remarksList.appendChild(remarkDiv);
                });
            }
            
            document.getElementById('newRemark').value = '';
            new bootstrap.Modal(document.getElementById('remarksModal')).show();
        }

        function addRemark() {
            const remarkText = document.getElementById('newRemark').value.trim();
            if (!remarkText) return;
            
            if (!entryRemarks[currentRemarksEntryId]) {
                entryRemarks[currentRemarksEntryId] = [];
            }
            
            entryRemarks[currentRemarksEntryId].push({
                text: remarkText,
                author: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            logActivity('Add Remark', `Remark added to entry #${currentRemarksEntryId} by ${currentUser.name}`);
            saveToStorage();
            viewRemarks(currentRemarksEntryId);
            renderLogbookEntries();
        }

        // Edit Request Management
        function requestEdit(entryId) {
            currentEntryId = entryId;
            document.getElementById('editRequestReason').value = '';
            new bootstrap.Modal(document.getElementById('editRequestModal')).show();
        }

        function submitEditRequest() {
            const reason = document.getElementById('editRequestReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the edit request');
                return;
            }
            
            const request = {
                id: Date.now(),
                entryId: currentEntryId,
                requestedBy: currentUser.id,
                requestedByName: currentUser.name,
                reason: reason,
                timestamp: new Date().toISOString(),
                resolved: false
            };
            
            editRequests.unshift(request);
            logActivity('Edit Request', `Edit request submitted for entry #${currentEntryId} by ${currentUser.name}`);
            saveToStorage();
            updateUI();
            bootstrap.Modal.getInstance(document.getElementById('editRequestModal')).hide();
            
            alert('Edit request submitted to admin (ID: 7434)');
        }

        function updateEditRequestBadge() {
            const pendingRequests = editRequests.filter(r => !r.resolved).length;
            const badge = document.getElementById('editRequestBadge');
            
            if (currentUser.role === 'admin' && pendingRequests > 0) {
                badge.textContent = pendingRequests;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // User Management
        function loadUsersPage() {
            const usersList = document.getElementById('usersList');
            const usersTitle = document.getElementById('usersTitle');
            
            if (currentUser.role === 'admin') {
                usersTitle.textContent = 'All Users';
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'card mb-3';
                    userCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="user-avatar mx-auto">${user.name.charAt(0)}</div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-1">${user.name}</h6>
                                    <p class="mb-1">ID: ${user.id}</p>
                                    <span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="commit${user.id}" 
                                               ${user.canCommit ? 'checked' : ''} 
                                               onchange="toggleCommitPermission('${user.id}')"
                                               ${user.role === 'admin' ? 'disabled' : ''}>
                                        <label class="form-check-label" for="commit${user.id}">
                                            Can Commit
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    usersList.appendChild(userCard);
                });
                
                loadActivityLog();
            } else {
                usersTitle.textContent = 'My Profile';
                usersList.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="user-avatar mx-auto" style="width: 80px; height: 80px; font-size: 2rem;">
                                        ${currentUser.name.charAt(0)}
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <h4>${currentUser.name}</h4>
                                    <p class="mb-1"><strong>ID:</strong> ${currentUser.id}</p>
                                    <p class="mb-1"><strong>Role:</strong> 
                                        <span class="badge ${currentUser.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${currentUser.role}</span>
                                    </p>
                                    <p class="mb-1"><strong>Outlet:</strong> VM:Switch VillageMall</p>
                                    <p class="mb-0"><strong>Can Commit:</strong> 
                                        <span class="badge ${currentUser.canCommit ? 'bg-success' : 'bg-danger'}">
                                            ${currentUser.canCommit ? 'Yes' : 'No'}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function toggleCommitPermission(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.role !== 'admin') {
                user.canCommit = !user.canCommit;
                logActivity('Toggle Permission', `Commit permission ${user.canCommit ? 'granted to' : 'revoked from'} ${user.name}`);
                saveToStorage();
            }
        }

        function loadActivityLog() {
            const activityLog = document.getElementById('activityLog');
            activityLog.innerHTML = '';
            
            // Show edit requests first
            const pendingRequests = editRequests.filter(r => !r.resolved);
            if (pendingRequests.length > 0) {
                const requestsHeader = document.createElement('h6');
                requestsHeader.className = 'text-warning mb-3';
                requestsHeader.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Pending Edit Requests';
                activityLog.appendChild(requestsHeader);
                
                pendingRequests.forEach(request => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'activity-item bg-warning bg-opacity-10 border border-warning';
                    requestDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${request.requestedByName}</strong> requests edit for Entry #${request.entryId}
                                <br><small class="text-muted">${new Date(request.timestamp).toLocaleString()}</small>
                                <br><em>"${request.reason}"</em>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="approveEditRequest(${request.id})">
                                Approve
                            </button>
                        </div>
                    `;
                    activityLog.appendChild(requestDiv);
                });
            }
            
            // Show recent activity
            const recentLogs = activityLogs.slice(0, 10);
            if (recentLogs.length > 0) {
                const logsHeader = document.createElement('h6');
                logsHeader.className = 'text-primary mb-3 mt-4';
                logsHeader.innerHTML = '<i class="fas fa-history me-2"></i>Recent Activity';
                activityLog.appendChild(logsHeader);
                
                recentLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'activity-item';
                    logDiv.innerHTML = `
                        <strong>${log.action}</strong>
                        <br><small class="text-muted">${log.details}</small>
                        <br><small class="text-muted">${new Date(log.timestamp).toLocaleString()}</small>
                    `;
                    activityLog.appendChild(logDiv);
                });
            }
        }

        function approveEditRequest(requestId) {
            const request = editRequests.find(r => r.id === requestId);
            if (request) {
                uncommitEntry(request.entryId);
                alert(`Edit request approved. Entry #${request.entryId} has been uncommitted and can now be edited.`);
            }
        }

        // Utility Functions
        function handlePhotoPreview() {
            const file = document.getElementById('entryPhoto').files[0];
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }

        function viewPhoto(photoSrc) {
            document.getElementById('modalPhoto').src = photoSrc;
            new bootstrap.Modal(document.getElementById('photoModal')).show();
        }

        function logActivity(action, details) {
            activityLogs.unshift({
                action: action,
                details: details,
                user: currentUser.name,
                userId: currentUser.id,
                timestamp: new Date().toISOString()
            });
            saveToStorage();
        }

        function updateUI() {
            if (currentUser) {
                loadLogbookPage();
                if (document.getElementById('usersPage').classList.contains('active')) {
                    loadUsersPage();
                }
            }
        }

        // Storage Management
        function saveToStorage() {
            localStorage.setItem('vmCourierData', JSON.stringify({
                users: users,
                logbookEntries: logbookEntries,
                deletedEntries: deletedEntries,
                editRequests: editRequests,
                activityLogs: activityLogs,
                entryRemarks: entryRemarks
            }));
        }

        function loadFromStorage() {
            const data = localStorage.getItem('vmCourierData');
            if (data) {
                const parsed = JSON.parse(data);
                users = parsed.users || users;
                logbookEntries = parsed.logbookEntries || [];
                deletedEntries = parsed.deletedEntries || [];
                editRequests = parsed.editRequests || [];
                activityLogs = parsed.activityLogs || [];
                entryRemarks = parsed.entryRemarks || {};
            }
        }
    </script>
</body>
</html>
